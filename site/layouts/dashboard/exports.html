{{ define "main" }}
<div class="dashboard" id="dashboard-app">
  <!-- Sidebar -->
  <aside class="dashboard__sidebar">
    <div class="dashboard__logo">
      <svg viewBox="0 0 40 40" width="32" height="32">
        <circle cx="20" cy="20" r="18" fill="none" stroke="#38bdf8" stroke-width="2"/>
        <circle cx="20" cy="12" r="4" fill="#22c55e"/>
        <circle cx="12" cy="24" r="3" fill="#38bdf8"/>
        <circle cx="28" cy="24" r="3" fill="#38bdf8"/>
        <line x1="20" y1="16" x2="12" y2="21" stroke="#475569" stroke-width="1.5"/>
        <line x1="20" y1="16" x2="28" y2="21" stroke="#475569" stroke-width="1.5"/>
      </svg>
      <span>VeilChain</span>
    </div>

    <nav class="dashboard__nav">
      <a href="/dashboard/" class="dashboard__nav-item">
        <i class="fas fa-home"></i>
        <span>Overview</span>
      </a>
      <a href="/dashboard/ledgers/" class="dashboard__nav-item">
        <i class="fas fa-database"></i>
        <span>Ledgers</span>
      </a>
      <a href="/dashboard/entries/" class="dashboard__nav-item">
        <i class="fas fa-list"></i>
        <span>Entries</span>
      </a>
      <a href="/dashboard/proofs/" class="dashboard__nav-item">
        <i class="fas fa-certificate"></i>
        <span>Proofs</span>
      </a>
      <a href="/dashboard/exports/" class="dashboard__nav-item active">
        <i class="fas fa-download"></i>
        <span>Export Data</span>
      </a>
      <a href="/dashboard/api-keys/" class="dashboard__nav-item">
        <i class="fas fa-key"></i>
        <span>API Keys</span>
      </a>
    </nav>

    <div class="dashboard__sidebar-footer">
      <a href="/dashboard/settings/" class="dashboard__nav-item">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </a>
      <button class="dashboard__nav-item" id="logout-btn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="dashboard__main">
    <header class="dashboard__header">
      <div class="dashboard__header-left">
        <button class="dashboard__mobile-toggle" id="mobile-toggle">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="dashboard__title">Export Data</h1>
      </div>
      <div class="dashboard__header-right">
        <div class="dashboard__user" id="user-info">
          <span class="dashboard__user-name"></span>
          <div class="dashboard__user-avatar">
            <i class="fas fa-user"></i>
          </div>
        </div>
      </div>
    </header>

    <!-- Export Form -->
    <section class="dashboard__section">
      <div class="dashboard__section-header">
        <h2>Export Ledger Data</h2>
      </div>

      <form id="export-form" class="export-form">
        <div class="export-form__group">
          <label class="export-form__label">Select Ledger</label>
          <select id="export-ledger" class="export-form__select" required>
            <option value="">Loading ledgers...</option>
          </select>
        </div>

        <div class="export-form__group">
          <label class="export-form__label">Export Format</label>
          <div class="export-form__options">
            <label class="export-form__radio">
              <input type="radio" name="format" value="json" checked>
              <span class="export-form__radio-custom"></span>
              <div>
                <strong>JSON</strong>
                <p>Full data with proofs included</p>
              </div>
            </label>
            <label class="export-form__radio">
              <input type="radio" name="format" value="csv">
              <span class="export-form__radio-custom"></span>
              <div>
                <strong>CSV</strong>
                <p>Spreadsheet-compatible format</p>
              </div>
            </label>
            <label class="export-form__radio">
              <input type="radio" name="format" value="tree">
              <span class="export-form__radio-custom"></span>
              <div>
                <strong>Merkle Tree</strong>
                <p>Full tree structure for verification</p>
              </div>
            </label>
          </div>
        </div>

        <div class="export-form__group">
          <label class="export-form__label">Data Range</label>
          <div class="export-form__range">
            <div class="export-form__field">
              <label>From Index</label>
              <input type="number" id="export-from" class="export-form__input" value="0" min="0">
            </div>
            <div class="export-form__field">
              <label>To Index</label>
              <input type="number" id="export-to" class="export-form__input" placeholder="Latest">
            </div>
          </div>
        </div>

        <div class="export-form__group">
          <label class="export-form__checkbox">
            <input type="checkbox" name="include-proofs" checked>
            <span>Include inclusion proofs for each entry</span>
          </label>
          <label class="export-form__checkbox">
            <input type="checkbox" name="include-metadata" checked>
            <span>Include metadata (timestamps, entry IDs)</span>
          </label>
        </div>

        <div class="export-form__actions">
          <button type="submit" class="btn-primary" id="export-btn">
            <i class="fas fa-download"></i>
            <span>Download Export</span>
          </button>
          <button type="button" class="btn-secondary" id="preview-btn">
            <i class="fas fa-eye"></i>
            <span>Preview</span>
          </button>
        </div>
      </form>
    </section>

    <!-- Export Preview -->
    <section class="dashboard__section" id="preview-section" style="display: none;">
      <div class="dashboard__section-header">
        <h2>Preview</h2>
        <button class="btn-link" id="close-preview">Close</button>
      </div>
      <div class="export-preview">
        <pre id="preview-content"></pre>
      </div>
    </section>

    <!-- Recent Exports -->
    <section class="dashboard__section">
      <div class="dashboard__section-header">
        <h2>Recent Exports</h2>
      </div>
      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>Ledger</th>
              <th>Format</th>
              <th>Entries</th>
              <th>Size</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="exports-table">
            <tr class="empty-row">
              <td colspan="6">No recent exports</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Export Info -->
    <section class="dashboard__section">
      <div class="dashboard__section-header">
        <h2>About Exports</h2>
      </div>
      <div class="info-grid">
        <div class="info-card">
          <i class="fas fa-file-code"></i>
          <h4>JSON Format</h4>
          <p>Complete data export with all fields, proofs, and metadata. Best for backups and programmatic access.</p>
        </div>
        <div class="info-card">
          <i class="fas fa-table"></i>
          <h4>CSV Format</h4>
          <p>Spreadsheet-compatible format for analysis in Excel, Google Sheets, or other tools. Proofs are optional.</p>
        </div>
        <div class="info-card">
          <i class="fas fa-sitemap"></i>
          <h4>Merkle Tree Format</h4>
          <p>Full tree structure export for independent verification. Use this to verify data integrity offline.</p>
        </div>
        <div class="info-card">
          <i class="fas fa-shield-alt"></i>
          <h4>Offline Verification</h4>
          <p>All exports include root hashes and proofs. Verify data integrity without connecting to VeilChain.</p>
        </div>
      </div>
    </section>
  </main>
</div>

<script src="/js/dashboard.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function() {
  if (!VeilChain.Auth.requireAuth()) return;

  const ledgerSelect = document.getElementById('export-ledger');
  const exportForm = document.getElementById('export-form');
  const previewSection = document.getElementById('preview-section');
  const previewContent = document.getElementById('preview-content');

  // Load ledgers
  try {
    const data = await VeilChain.API.get('/ledgers');
    ledgerSelect.innerHTML = data.ledgers.length > 0
      ? data.ledgers.map(l => `<option value="${l.id}">${l.name} (${l.size} entries)</option>`).join('')
      : '<option value="">No ledgers available</option>';
  } catch (err) {
    ledgerSelect.innerHTML = '<option value="">Failed to load ledgers</option>';
  }

  // Export form submission
  exportForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const ledgerId = ledgerSelect.value;
    if (!ledgerId) {
      VeilChain.Utils.showToast('Please select a ledger', 'error');
      return;
    }

    const format = document.querySelector('input[name="format"]:checked').value;
    const fromIndex = document.getElementById('export-from').value || 0;
    const toIndex = document.getElementById('export-to').value || '';
    const includeProofs = document.querySelector('input[name="include-proofs"]').checked;
    const includeMetadata = document.querySelector('input[name="include-metadata"]').checked;

    const params = new URLSearchParams({
      format,
      from: fromIndex,
      ...(toIndex && { to: toIndex }),
      proofs: includeProofs,
      metadata: includeMetadata
    });

    try {
      const response = await VeilChain.API.fetch(`/ledgers/${ledgerId}/export?${params}`);
      const blob = await response.blob();

      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ledger-${ledgerId}.${format === 'tree' ? 'json' : format}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      VeilChain.Utils.showToast('Export completed successfully');
    } catch (err) {
      VeilChain.Utils.showToast('Export failed: ' + err.message, 'error');
    }
  });

  // Preview button
  document.getElementById('preview-btn').addEventListener('click', async function() {
    const ledgerId = ledgerSelect.value;
    if (!ledgerId) {
      VeilChain.Utils.showToast('Please select a ledger', 'error');
      return;
    }

    const format = document.querySelector('input[name="format"]:checked').value;

    try {
      const data = await VeilChain.API.get(`/ledgers/${ledgerId}/export?format=${format}&limit=5`);
      previewContent.textContent = JSON.stringify(data, null, 2);
      previewSection.style.display = 'block';
      previewSection.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      VeilChain.Utils.showToast('Preview failed', 'error');
    }
  });

  document.getElementById('close-preview').addEventListener('click', function() {
    previewSection.style.display = 'none';
  });
});
</script>
{{ end }}
